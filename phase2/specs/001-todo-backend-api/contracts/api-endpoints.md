# API Endpoint Contracts

**Feature**: 001-todo-backend-api
**Base URL**: `http://localhost:8000` (development)
**API Prefix**: `/api`
**Date**: 2026-01-08

## Authentication

**All endpoints** (except health check) require JWT authentication.

### Request Header

```
Authorization: Bearer <jwt_token>
```

### JWT Token Structure

**Expected Payload**:
```json
{
  "userId": "user-uuid-123",
  "email": "user@example.com",
  "iat": 1704672000,
  "exp": 1704758400
}
```

**Required Claims**:
- `userId` (string): User's unique identifier
- `exp` (number): Token expiration timestamp

**Signing Algorithm**: HS256
**Secret Key**: `BETTER_AUTH_SECRET` (shared with Better Auth)

---

## Endpoint: List Tasks

**GET** `/api/tasks`

### Description
Retrieve all tasks belonging to the authenticated user.

### Request

**Headers**:
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Body**: None

**Query Parameters**: None

### Response

**Status 200 OK** (Success - tasks found):
```json
[
  {
    "id": 1,
    "user_id": "user-uuid-123",
    "title": "Buy groceries",
    "description": "Milk, eggs, bread",
    "completed": false,
    "created_at": "2026-01-08T10:00:00Z",
    "updated_at": "2026-01-08T10:00:00Z"
  },
  {
    "id": 2,
    "user_id": "user-uuid-123",
    "title": "Write documentation",
    "description": null,
    "completed": true,
    "created_at": "2026-01-08T11:00:00Z",
    "updated_at": "2026-01-08T12:00:00Z"
  }
]
```

**Status 200 OK** (Success - no tasks):
```json
[]
```

**Status 401 Unauthorized** (Missing or invalid token):
```json
{
  "detail": "Invalid authentication credentials"
}
```

### Behavior

- Returns only tasks where `user_id` matches authenticated user
- Returns empty array if user has no tasks
- Tasks ordered by `created_at` descending (newest first)
- Description can be `null` if not provided

### cURL Example

```bash
curl -X GET "http://localhost:8000/api/tasks" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

---

## Endpoint: Create Task

**POST** `/api/tasks`

### Description
Create a new task for the authenticated user.

### Request

**Headers**:
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json
```

**Body** (with description):
```json
{
  "title": "Buy groceries",
  "description": "Milk, eggs, bread"
}
```

**Body** (without description):
```json
{
  "title": "Call dentist"
}
```

### Response

**Status 201 Created** (Success):
```json
{
  "id": 3,
  "user_id": "user-uuid-123",
  "title": "Buy groceries",
  "description": "Milk, eggs, bread",
  "completed": false,
  "created_at": "2026-01-08T14:30:00Z",
  "updated_at": "2026-01-08T14:30:00Z"
}
```

**Status 422 Unprocessable Entity** (Validation error - missing title):
```json
{
  "detail": [
    {
      "type": "missing",
      "loc": ["body", "title"],
      "msg": "Field required",
      "input": {}
    }
  ]
}
```

**Status 422 Unprocessable Entity** (Validation error - title too long):
```json
{
  "detail": [
    {
      "type": "string_too_long",
      "loc": ["body", "title"],
      "msg": "String should have at most 200 characters",
      "input": "Very long title that exceeds 200 characters...",
      "ctx": {"max_length": 200}
    }
  ]
}
```

**Status 401 Unauthorized** (Missing or invalid token):
```json
{
  "detail": "Invalid authentication credentials"
}
```

### Behavior

- `user_id` automatically set from JWT token (not in request body)
- `completed` defaults to `false`
- `created_at` and `updated_at` automatically set to current timestamp
- `id` auto-generated by database
- `description` optional (defaults to `null`)

### Validation Rules

- `title`: Required, 1-200 characters
- `description`: Optional, max 1000 characters

### cURL Example

```bash
curl -X POST "http://localhost:8000/api/tasks" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"title": "Buy groceries", "description": "Milk, eggs, bread"}'
```

---

## Endpoint: Get Task by ID

**GET** `/api/tasks/{id}`

### Description
Retrieve a specific task by ID. Only returns the task if it belongs to the authenticated user.

### Request

**Headers**:
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Path Parameters**:
- `id` (integer): Task ID

**Body**: None

### Response

**Status 200 OK** (Success):
```json
{
  "id": 1,
  "user_id": "user-uuid-123",
  "title": "Buy groceries",
  "description": "Milk, eggs, bread",
  "completed": false,
  "created_at": "2026-01-08T10:00:00Z",
  "updated_at": "2026-01-08T10:00:00Z"
}
```

**Status 404 Not Found** (Task doesn't exist):
```json
{
  "detail": "Task not found"
}
```

**Status 404 Not Found** (Task belongs to different user):
```json
{
  "detail": "Task not found"
}
```

**Status 401 Unauthorized** (Missing or invalid token):
```json
{
  "detail": "Invalid authentication credentials"
}
```

**Status 422 Unprocessable Entity** (Invalid ID format):
```json
{
  "detail": [
    {
      "type": "int_parsing",
      "loc": ["path", "id"],
      "msg": "Input should be a valid integer",
      "input": "abc"
    }
  ]
}
```

### Behavior

- Returns 404 if task doesn't exist OR belongs to different user (prevents user enumeration)
- Ownership verified: `task.user_id == authenticated_user_id`

### cURL Example

```bash
curl -X GET "http://localhost:8000/api/tasks/1" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

---

## Endpoint: Update Task

**PUT** `/api/tasks/{id}`

### Description
Update a task's title and/or description. Only the task owner can update it.

### Request

**Headers**:
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json
```

**Path Parameters**:
- `id` (integer): Task ID

**Body** (update both fields):
```json
{
  "title": "Buy groceries and cook dinner",
  "description": "Milk, eggs, bread, chicken, vegetables"
}
```

**Body** (update title only):
```json
{
  "title": "Buy groceries and cook"
}
```

**Body** (update description only):
```json
{
  "description": "Updated description"
}
```

### Response

**Status 200 OK** (Success):
```json
{
  "id": 1,
  "user_id": "user-uuid-123",
  "title": "Buy groceries and cook dinner",
  "description": "Milk, eggs, bread, chicken, vegetables",
  "completed": false,
  "created_at": "2026-01-08T10:00:00Z",
  "updated_at": "2026-01-08T15:30:00Z"
}
```

**Status 404 Not Found** (Task doesn't exist or wrong owner):
```json
{
  "detail": "Task not found"
}
```

**Status 422 Unprocessable Entity** (Validation error):
```json
{
  "detail": [
    {
      "type": "string_too_long",
      "loc": ["body", "title"],
      "msg": "String should have at most 200 characters",
      "input": "Very long title...",
      "ctx": {"max_length": 200}
    }
  ]
}
```

**Status 401 Unauthorized** (Missing or invalid token):
```json
{
  "detail": "Invalid authentication credentials"
}
```

### Behavior

- Only provided fields are updated (partial update)
- `updated_at` timestamp automatically updated to current time
- `created_at` remains unchanged
- `completed` status not affected (use PATCH /complete for that)
- Ownership verified before update

### Validation Rules

- `title`: Optional in request, but if provided: 1-200 characters
- `description`: Optional in request, but if provided: max 1000 characters

### cURL Example

```bash
curl -X PUT "http://localhost:8000/api/tasks/1" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"title": "Updated title", "description": "Updated description"}'
```

---

## Endpoint: Toggle Task Completion

**PATCH** `/api/tasks/{id}/complete`

### Description
Toggle the completion status of a task (false → true or true → false).

### Request

**Headers**:
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Path Parameters**:
- `id` (integer): Task ID

**Body**: None

### Response

**Status 200 OK** (Success - toggled to complete):
```json
{
  "id": 1,
  "user_id": "user-uuid-123",
  "title": "Buy groceries",
  "description": "Milk, eggs, bread",
  "completed": true,
  "created_at": "2026-01-08T10:00:00Z",
  "updated_at": "2026-01-08T16:00:00Z"
}
```

**Status 200 OK** (Success - toggled to incomplete):
```json
{
  "id": 1,
  "user_id": "user-uuid-123",
  "title": "Buy groceries",
  "description": "Milk, eggs, bread",
  "completed": false,
  "created_at": "2026-01-08T10:00:00Z",
  "updated_at": "2026-01-08T16:05:00Z"
}
```

**Status 404 Not Found** (Task doesn't exist or wrong owner):
```json
{
  "detail": "Task not found"
}
```

**Status 401 Unauthorized** (Missing or invalid token):
```json
{
  "detail": "Invalid authentication credentials"
}
```

### Behavior

- Toggles `completed` boolean: `task.completed = not task.completed`
- `updated_at` timestamp automatically updated
- `title`, `description` remain unchanged
- Ownership verified before toggling

### cURL Example

```bash
curl -X PATCH "http://localhost:8000/api/tasks/1/complete" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

---

## Endpoint: Delete Task

**DELETE** `/api/tasks/{id}`

### Description
Permanently delete a task. Only the task owner can delete it.

### Request

**Headers**:
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Path Parameters**:
- `id` (integer): Task ID

**Body**: None

### Response

**Status 204 No Content** (Success):
```
(No response body)
```

**Status 404 Not Found** (Task doesn't exist or wrong owner):
```json
{
  "detail": "Task not found"
}
```

**Status 401 Unauthorized** (Missing or invalid token):
```json
{
  "detail": "Invalid authentication credentials"
}
```

### Behavior

- Task permanently removed from database
- No response body on success (204 status indicates success)
- Ownership verified before deletion
- Idempotent: Deleting already-deleted task returns 404

### cURL Example

```bash
curl -X DELETE "http://localhost:8000/api/tasks/1" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

---

## Endpoint: Health Check

**GET** `/api/health`

### Description
Health check endpoint for monitoring. Does NOT require authentication.

### Request

**Headers**: None required

**Body**: None

### Response

**Status 200 OK** (Service healthy):
```json
{
  "status": "healthy",
  "timestamp": "2026-01-08T17:00:00Z"
}
```

### Behavior

- No authentication required
- Verifies server is running
- Does not check database connection (simple liveness check)

### cURL Example

```bash
curl -X GET "http://localhost:8000/api/health"
```

---

## Error Response Format

All error responses follow FastAPI's standard format:

### Single Error

```json
{
  "detail": "Error message"
}
```

### Validation Errors (422)

```json
{
  "detail": [
    {
      "type": "error_type",
      "loc": ["body", "field_name"],
      "msg": "Human-readable error message",
      "input": "Invalid input value",
      "ctx": {"additional": "context"}
    }
  ]
}
```

---

## HTTP Status Codes

| Status | Meaning                  | When Used                                    |
|--------|--------------------------|----------------------------------------------|
| 200    | OK                       | Successful GET, PUT, PATCH                   |
| 201    | Created                  | Successful POST                              |
| 204    | No Content               | Successful DELETE                            |
| 401    | Unauthorized             | Missing/invalid JWT token                    |
| 404    | Not Found                | Task doesn't exist or wrong owner            |
| 422    | Unprocessable Entity     | Validation error (invalid input)             |
| 500    | Internal Server Error    | Server error (database connection, etc.)     |

---

## CORS Configuration

**Allowed Origins** (development):
- `http://localhost:3000` (Next.js frontend)

**Allowed Methods**:
- GET, POST, PUT, PATCH, DELETE, OPTIONS

**Allowed Headers**:
- Authorization, Content-Type

**Allow Credentials**: Yes (for cookies if needed)

### Preflight Request (OPTIONS)

Browsers automatically send OPTIONS request before actual request:

**Request**:
```
OPTIONS /api/tasks HTTP/1.1
Origin: http://localhost:3000
Access-Control-Request-Method: POST
Access-Control-Request-Headers: authorization,content-type
```

**Response**:
```
HTTP/1.1 200 OK
Access-Control-Allow-Origin: http://localhost:3000
Access-Control-Allow-Methods: GET, POST, PUT, PATCH, DELETE, OPTIONS
Access-Control-Allow-Headers: authorization, content-type
Access-Control-Allow-Credentials: true
```

---

## Testing Contracts

### Manual Testing with cURL

1. **Get JWT token** (from Better Auth or generate test token)
2. **Test health check**: `curl http://localhost:8000/api/health`
3. **Test list tasks**: `curl -H "Authorization: Bearer TOKEN" http://localhost:8000/api/tasks`
4. **Test create task**: See POST example above
5. **Test other endpoints**: See individual endpoint examples

### Postman Collection

Import these endpoints into Postman:
- Set `{{base_url}}` variable to `http://localhost:8000`
- Set `{{token}}` variable to your JWT token
- Use collection runner to test all endpoints

### Expected OpenAPI Documentation

FastAPI auto-generates docs at:
- **Swagger UI**: `http://localhost:8000/docs`
- **ReDoc**: `http://localhost:8000/redoc`
- **OpenAPI JSON**: `http://localhost:8000/openapi.json`

---

## Contract Validation Checklist

- [x] All endpoints use `/api/` prefix
- [x] Authentication header required (except health check)
- [x] RESTful HTTP methods (GET, POST, PUT, PATCH, DELETE)
- [x] JSON request/response format
- [x] Proper HTTP status codes (200, 201, 204, 401, 404, 422, 500)
- [x] Error responses include `detail` field
- [x] Validation errors include field location and message
- [x] Timestamps in ISO 8601 format
- [x] Ownership validation on all task operations
- [x] 404 (not 403) for unauthorized access (prevents enumeration)
- [x] CORS configuration for frontend origin
- [x] cURL examples for all endpoints
- [x] OpenAPI/Swagger documentation

---

## Summary

**Total Endpoints**: 7 (6 task operations + 1 health check)

**Authentication**: JWT Bearer token (except health check)

**Data Format**: JSON request/response

**Error Handling**: Consistent error response format

**Constitution Compliance**: ✅ All API-first design requirements met
